!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}({"./index.js":function(e,t,r){"use strict";r.r(t),function(e){r("./src/lib/utils/index.js");var t=r("express"),n=r.n(t),i=r("cors"),a=r.n(i),o=r("body-parser"),p=r.n(o),c=r("morgan"),s=r.n(c),u=r("http"),d=r.n(u),l=r("./src/routes/graph/index.js"),y=r("./src/lib/security-middleware/index.js"),h=r("path"),m=r.n(h),f=r("express-rate-limit"),g=r.n(f),_=n()();_.disable("x-powered-by"),_.use(p.a.urlencoded({extended:!0})),_.use(p.a.json()),_.use(s()(":method :url :status :res[content-length] - :response-time ms")),_.use("/images",n.a.static(m.a.join(e,"images/products")));var v={"http://0.0.0.0:4000/":!0,"http://0.0.0.0:4000":!0,"http://localhost:4000":!0,"http://localhost:4000/":!0,"http://34.217.129.189:4000":!0,"http://34.217.129.189:4000/":!0},b={origin:function(e,t){if(v[e])return t(null,!0);t(new Error("ERR_CORS"))}};_.use(a()(b));var G=g()({windowMs:6e4,max:60});_.use("/api",G);var L=Object(y.a)({credentialsRequired:!1});_.use("/api",L),_.use("/",l.a),_.use(function(e,t,r,n){if(e)switch(e.message){case"AUTHORIZATION_ERROR":return r.status(401).json({code:403,message:"Authorization error"});case"ERR_CORS":return r.status(403).json({code:403,message:"Not allowed by CORS"});default:return r.status(e.status||500).json({code:e.status||500,message:e.message.charAt(0).toUpperCase()+e.message.slice(1)})}return n()}),d.a.createServer(_).listen(3035,function(){console.log("HTTP Server running on 3035")})}.call(this,"")},"./src/lib/crypt/index.js":function(e,t,r){"use strict";var n=r("cryptr"),i=r.n(n);r.d(t,"a",function(){return o}),r.d(t,"b",function(){return p});var a=new i.a("myTotalySecretKey"),o=function(e){var t;try{t=a.decrypt(e)}catch(e){throw new Error("invalid_token")}return t},p=function(e){return a.encrypt(e)}},"./src/lib/security-middleware/UnauthorizedError.js":function(e,t){function r(e,t){this.name="UnauthorizedError",this.message=t.message,Error.call(this,t.message),Error.captureStackTrace(this,this.constructor),this.code=e,this.status=401,this.inner=t}r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,e.exports=r},"./src/lib/security-middleware/index.js":function(e,t,r){"use strict";var n=r("./src/lib/security-middleware/UnauthorizedError.js"),i=r.n(n),a=r("async"),o=r.n(a),p=r("express-unless"),c=r.n(p),s=r("./src/lib/crypt/index.js"),u=function(e,t,r){return r(null,!1)};t.a=function(e){var t,r,n=e.secret;r=n,"[object Function]"!==Object.prototype.toString.call(r)&&(t=n,n=function(e,r,n){return n(null,t)});var a=e.isRevoked||u,p=e.userProperty||e.requestProperty||"user",d=e.resultProperty,l=void 0===e.credentialsRequired||e.credentialsRequired,y=function(t,r,n){var c;if("OPTIONS"===t.method&&t.headers.hasOwnProperty("access-control-request-headers")&&!!~t.headers["access-control-request-headers"].split(",").map(function(e){return e.trim()}).indexOf("authorization"))return n();if(e.getToken&&"function"==typeof e.getToken)try{c=e.getToken(t)}catch(e){return n(e)}else if(t.headers&&t.headers.authorization){var u=t.headers.authorization.split(" ");if(2!=u.length)return n(new i.a("credentials_bad_format",{message:"Format is Authorization: Bearer [token]"}));var y=u[0],h=u[1];if(!/^Bearer$/i.test(y))return l?n(new i.a("credentials_bad_scheme",{message:"Format is Authorization: Bearer [token]"})):n();c=h}if(!c)return l?n(new i.a("credentials_required",{message:"No authorization token was found"})):n();o.a.waterfall([function(e){var t;try{t=Object(s.a)(c),t=JSON.parse(t),console.log("=======",{decoded:t}),e(null,t)}catch(t){e(new i.a("invalid_token",t))}},function(e,r){a(t,e,function(t,n){t?r(t):n?r(new i.a("revoked_token",{message:"The token has been revoked."})):r(null,e)})}],function(e,i){if(e)return n(e);d?r[d]=i:t[p]=i,n()})};return y.unless=c.a,y.UnauthorizedError=i.a,y}},"./src/lib/utils/index.js":function(e,t,r){"use strict";r.d(t,"a",function(){return n});var n=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return e.operation.selectionSet.selections[0].selectionSet.selections.map(function(e){return t[e.name.value]?t[e.name.value]:e.name.value})}},"./src/routes/graph/index.js":function(e,t,r){"use strict";var n="/api",i={ide:!1,pretty:!0},a=r("graphql"),o=new a.GraphQLObjectType({name:"customer",description:"customer",fields:function(){return{name:{type:a.GraphQLString},email:{type:a.GraphQLString},credit_card:{type:a.GraphQLString},address_1:{type:a.GraphQLString},address_2:{type:a.GraphQLString},city:{type:a.GraphQLString},region:{type:a.GraphQLString},postal_code:{type:a.GraphQLString},country:{type:a.GraphQLString},shippingRegionId:{type:a.GraphQLInt},shippingRegionName:{type:a.GraphQLString},day_phone:{type:a.GraphQLString},eve_phone:{type:a.GraphQLString},mob_phone:{type:a.GraphQLString},token:{type:a.GraphQLString}}}}),p=r("sequelize"),c=r.n(p);r("dotenv").config();var s={username:process.env.DB_USER,password:process.env.DB_PASS,database:process.env.DB_DATABASE,host:process.env.DB_HOST,port:process.env.DB_PORT,dialect:"mysql"};console.log(s);var u=s,d=new p.Sequelize({username:u.username,port:u.port,password:u.password,database:u.database,host:u.host,dialect:u.dialect});console.info("SETUP -- CONNECTTION TO DATABASE..."),d.authenticate().then(function(){console.info("=====DATABASE CONNECTED======")}).catch(function(e){console.error("======UNABLE TO CONNECT TO DATABASE=======",e)});var l=d,y={products:l.import("products",function(e,t){var r=e.define("product",{id:{type:t.INTEGER,primaryKey:!0,field:"product_id",autoIncrement:!0},name:{type:t.STRING},description:{type:t.STRING},price:{type:t.DECIMAL},discounted_price:{type:t.DECIMAL},image:{type:t.STRING},image_2:{type:t.STRING},thumbnail:{type:t.STRING},display:{type:t.SMALLINT}},{tableName:"product",timestamps:!1});return r.associate=function(e){e.products.belongsToMany(e.categories,{through:e.product_category,foreignKey:"product_id"}),e.products.belongsToMany(e.attribute_value,{foreignKey:"product_id",through:e.product_attribute}),e.products.hasMany(e.product_attribute,{foreignKey:"id"})},r}),categories:l.import("categories",function(e,t){var r=e.define("category",{id:{type:t.INTEGER,primaryKey:!0,field:"category_id",autoIncrement:!0},department_id:{type:t.INTEGER},name:{type:t.STRING},description:{type:t.STRING}},{tableName:"category",timestamps:!1});return r.associate=function(e){e.categories.belongsToMany(e.products,{through:e.product_category,foreignKey:"category_id"}),e.categories.belongsTo(e.departments,{keyTarget:"department_id",foreignKey:"department_id"})},r}),departments:l.import("departments",function(e,t){var r=e.define("department",{id:{type:t.INTEGER,primaryKey:!0,field:"department_id",autoIncrement:!0},name:{type:t.STRING},description:{type:t.STRING}},{tableName:"department",timestamps:!1});return r.associate=function(e){e.departments.hasMany(e.categories,{foreignKey:"department_id",targetKey:"department_id"})},r}),product_category:l.import("product_category",function(e,t){return e.define("product_category",{product_id:{type:t.INTEGER,primaryKey:!0},category_id:{type:t.INTEGER,primaryKey:!0}},{tableName:"product_category",timestamps:!1})}),attribute:l.import("attribute",function(e,t){var r=e.define("attribute",{id:{type:t.INTEGER,primaryKey:!0,field:"attribute_id",autoIncrement:!0},name:{type:t.STRING}},{tableName:"attribute",timestamps:!1});return r.associate=function(e){e.attribute.hasMany(e.attribute_value,{foreignKey:"attribute_id",sourceKey:"id"})},r}),attribute_value:l.import("attribute_value",function(e,t){return e.define("attribute_value",{id:{type:t.INTEGER,primaryKey:!0,field:"attribute_value_id",autoIncrement:!0},attribute_id:{type:t.INTEGER},value:{type:t.STRING}},{tableName:"attribute_value",timestamps:!1})}),product_attribute:l.import("product_attribute",function(e,t){return e.define("product_attribute",{product_id:{type:t.INTEGER,primaryKey:!0},attribute_value_id:{type:t.INTEGER,primaryKey:!0}},{tableName:"product_attribute",timestamps:!1})}),orders:l.import("orders",function(e,t){var r=e.define("orders",{id:{type:t.INTEGER,primaryKey:!0,field:"order_id",autoIncrement:!0},total_amount:{type:t.DECIMAL},created_on:{type:t.DATE},shipped_on:{type:t.DATE},status:{type:t.INTEGER},comments:{type:t.STRING},customer_id:{type:t.INTEGER},auth_code:{type:t.STRING},reference:{type:t.STRING},shipping_id:{type:t.INTEGER},tax_id:{type:t.INTEGER}},{tableName:"orders",timestamps:!1});return r.associate=function(e){e.orders.hasMany(e.order_detail,{foreignKey:"order_id",targetKey:"order_id"})},r}),order_detail:l.import("order_detail",function(e,t){var r=e.define("order_detail",{id:{type:t.INTEGER,primaryKey:!0,field:"item_id",autoIncrement:!0},order_id:{type:t.INTEGER},product_id:{type:t.INTEGER},attributes:{type:t.STRING},product_name:{type:t.STRING},quantity:{type:t.INTEGER},unit_cost:{type:t.DECIMAL}},{tableName:"order_detail",timestamps:!1});return r.associate=function(e){e.order_detail.belongsTo(e.orders)},r}),customer:l.import("customer",function(e,t){var r=e.define("customer",{id:{type:t.INTEGER,primaryKey:!0,field:"customer_id",autoIncrement:!0},name:{type:t.STRING},email:{type:t.STRING},password:{type:t.STRING},credit_card:{type:t.STRING},address_1:{type:t.STRING},address_2:{type:t.STRING},city:{type:t.STRING},region:{type:t.STRING},postal_code:{type:t.STRING},country:{type:t.STRING},shipping_region_id:{type:t.INTEGER},day_phone:{type:t.STRING},eve_phone:{type:t.STRING},mob_phone:{type:t.STRING}},{tableName:"customer",timestamps:!1});return r.associate=function(e){e.customer.hasOne(e.shipping_region,{foreignKey:"shipping_region_id"})},r}),shipping_region:l.import("shipping_region",function(e,t){var r=e.define("shipping_region",{id:{type:t.INTEGER,primaryKey:!0,field:"shipping_region_id",autoIncrement:!0},shipping_region:{type:t.STRING}},{tableName:"shipping_region",timestamps:!1});return r.associate=function(e){e.shipping_region.belongsTo(e.customer,{foreignKey:"shipping_region_id"}),e.shipping_region.hasMany(e.shipping,{foreignKey:"shipping_region_id",targetKey:"shipping_region_id",as:"shipping"})},r}),review:l.import("review",function(e,t){var r=e.define("review",{id:{type:t.INTEGER,primaryKey:!0,field:"review_id",autoIncrement:!0},customer_id:{type:t.INTEGER},product_id:{type:t.INTEGER},review:{type:t.STRING},rating:{type:t.INTEGER},created_on:{type:t.DATE}},{tableName:"review",timestamps:!1});return r.associate=function(e){e.review.hasOne(e.customer,{foreignKey:"customer_id"}),e.review.hasOne(e.products,{foreignKey:"product_id"})},r}),shipping:l.import("shipping",function(e,t){return e.define("shipping",{id:{type:t.INTEGER,primaryKey:!0,field:"shipping_id",autoIncrement:!0},shipping_type:{type:t.STRING},shipping_cost:{type:t.DECIMAL},shipping_region_id:{type:t.INTEGER}},{tableName:"shipping",timestamps:!1})})};Object.keys(y).forEach(function(e){"associate"in y[e]&&y[e].associate(y)}),y.sequelize=l,y.Sequelize=c.a;var h=y,m=r("sha1"),f=r.n(m),g=r("./src/lib/utils/index.js"),_=r("./src/lib/crypt/index.js");function v(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function b(e,t,r,n,i,a,o){try{var p=e[a](o),c=p.value}catch(e){return void r(e)}p.done?t(c):Promise.resolve(c).then(n,i)}function G(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var a=e.apply(t,r);function o(e){b(a,n,i,o,p,"next",e)}function p(e){b(a,n,i,o,p,"throw",e)}o(void 0)})}}var L={shippingRegionName:[h.Sequelize.literal("`shipping_region`.`shipping_region`"),"shippingRegionName"],shippingRegionId:[h.Sequelize.literal("`shipping_region`.`shipping_region_id`"),"shippingRegionId"]},w=function(){var e=G(regeneratorRuntime.mark(function e(t,r,n,i){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(g.a)(i,L),e.next=3,h.customer.findAll({attributes:a,include:[{attributes:[],model:h.shipping_region}],raw:!0});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e)}));return function(t,r,n,i){return e.apply(this,arguments)}}(),S=function(){var e=G(regeneratorRuntime.mark(function e(t,r,n,i){var a,o,p,c,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(g.a)(i,L).filter(function(e){return"token"!=e}),o=r.email,p=r.password,c=r.isGoogle,e.next=4,h.customer.findOne({attributes:[].concat(v(a),["password","id"]),where:{email:o},include:[{attributes:[],model:h.shipping_region}],raw:!0});case 4:if(s=e.sent){e.next=7;break}throw new Error("USER_NOT_EXIST");case 7:if(f()(p)!==s.password&&!c){e.next=10;break}return s.token=Object(_.b)(JSON.stringify({id:s.id,scope:"user",expiration:null})),e.abrupt("return",s);case 10:throw new Error("WRONG_PASS");case 11:case"end":return e.stop()}},e)}));return function(t,r,n,i){return e.apply(this,arguments)}}(),T=function(){var e=G(regeneratorRuntime.mark(function e(t,r,n,i){var a,o,p,c,s,u,d;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.firstname,o=r.lastname,p=r.email,c=r.password,s=r.isGoogle,void 0!==s&&s,e.next=3,h.customer.count({where:{email:p},raw:!0});case 3:if(!(e.sent>0)){e.next=6;break}throw new Error("USER_EXISTS");case 6:return e.prev=6,e.next=9,h.customer.create({name:"".concat(a," ").concat(o),email:p,password:f()(c)},{raw:!0});case 9:return u=e.sent,(d=u.get({plain:!0})).token=Object(_.b)(JSON.stringify({id:d.id,scope:"user",expiration:null})),e.abrupt("return",d);case 15:throw e.prev=15,e.t0=e.catch(6),new Error("INSERT_ERROR",e.t0);case 18:case"end":return e.stop()}},e,null,[[6,15]])}));return function(t,r,n,i){return e.apply(this,arguments)}}(),I={},R={};R.registerCustomer={type:o,args:{firstname:{type:Object(a.GraphQLNonNull)(a.GraphQLString)},lastname:{type:Object(a.GraphQLNonNull)(a.GraphQLString)},email:{type:Object(a.GraphQLNonNull)(a.GraphQLString)},password:{type:Object(a.GraphQLNonNull)(a.GraphQLString)},isGoogle:{type:a.GraphQLBoolean}},resolve:T},I.customers={type:Object(a.GraphQLList)(o),resolve:w},I.customerLogin={type:o,args:{email:{type:Object(a.GraphQLNonNull)(a.GraphQLString)},password:{type:Object(a.GraphQLNonNull)(a.GraphQLString)},isGoogle:{type:a.GraphQLBoolean}},resolve:S};var E=new a.GraphQLObjectType({name:"products",description:"products",fields:function(){return{id:{type:a.GraphQLInt},name:{type:a.GraphQLString},description:{type:a.GraphQLString},price:{type:a.GraphQLFloat},discounted_price:{type:a.GraphQLFloat},image:{type:a.GraphQLString},image_2:{type:a.GraphQLString},thumbnail:{type:a.GraphQLString},display:{type:a.GraphQLInt},categoryName:{type:a.GraphQLString},categoryId:{type:a.GraphQLInt},departmentId:{type:a.GraphQLInt},departmentName:{type:a.GraphQLString},colors:{type:a.GraphQLString},sizes:{type:a.GraphQLString}}}}),N=new a.GraphQLInputObjectType({name:"DataPage",fields:function(){return{limit:{type:a.GraphQLInt},offset:{type:a.GraphQLInt}}}}),Q=r("node-cache"),x=r.n(Q);function O(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var j=new(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.cache=new x.a({stdTTL:t,checkperiod:.2*t,useClones:!1})}var t,r,n;return t=e,(r=[{key:"get",value:function(e,t){var r=this,n=this.cache.get(e);return n?Promise.resolve(n):t().then(function(t){return r.cache.set(e,t),t})}},{key:"del",value:function(e){this.cache.del(e)}},{key:"delStartWith",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(e){var t=this.cache.keys(),r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var p=a.value;0===p.indexOf(e)&&this.del(p)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}}}},{key:"flush",value:function(){this.cache.flushAll()}}])&&O(t.prototype,r),n&&O(t,n),e}())(1);function A(e,t,r,n,i,a,o){try{var p=e[a](o),c=p.value}catch(e){return void r(e)}p.done?t(c):Promise.resolve(c).then(n,i)}function P(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var a=e.apply(t,r);function o(e){A(a,n,i,o,p,"next",e)}function p(e){A(a,n,i,o,p,"throw",e)}o(void 0)})}}function k(){return(k=P(regeneratorRuntime.mark(function e(t,r,n,i){var a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,h.products.max("price");case 3:return a=e.sent,e.next=6,h.products.min("price");case 6:return o=e.sent,e.abrupt("return",{min:o,max:a});case 10:e.prev=10,e.t0=e.catch(0),console.log({e:e.t0});case 13:case"end":return e.stop()}},e,null,[[0,10]])}))).apply(this,arguments)}function q(){return(q=P(regeneratorRuntime.mark(function e(t,r,n,i){var a,o,p,c,s,u,d,l,y,m,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.categoryId,o=r.departmentId,p=r.paging,c=r.id,s=r.notId,u=r.autoComplete,d=r.color,l=r.size,y=r.minPrice,m=r.maxPrice,f=c?"product_".concat(c):"product_c".concat(a||"","_d").concat(o||"","_o").concat(p?p.offset:"","_ac").concat(u||"","_c").concat(d||"","_s").concat(l||""),e.next=5,j.get(f,P(regeneratorRuntime.mark(function e(){var t,r,n,i,f,g;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t="SELECT p.*, p.product_id id,\n                c.category_id categoryId,\n                c.department_id departmentId,\n                (SELECT  group_concat(UPPER(av.value)) sizes from attribute a join attribute_value av ON a.attribute_id = av.attribute_id join product_attribute pa on (pa.attribute_value_id=av.attribute_value_id) where pa.product_id = p.product_id and a.attribute_id = 1 group by av.attribute_id) sizes,\n                (SELECT  group_concat(LOWER(av.value)) colors   from attribute a join attribute_value av ON a.attribute_id = av.attribute_id join product_attribute pa on (pa.attribute_value_id=av.attribute_value_id) where pa.product_id = p.product_id and a.attribute_id = 2 group by av.attribute_id) colors \n                FROM product p\n                    JOIN product_attribute pa ON p.product_id = pa.product_id \n                    JOIN attribute_value av ON av.attribute_value_id = pa.attribute_value_id \n                    JOIN product_category pc ON pc.product_id = p.product_id\n                    JOIN category c ON c.category_id = pc.category_id\n                WHERE p.display IN (0,1,2,3,4)\n                    ".concat(c?"AND p.product_id = ".concat(c):"","\n                    ").concat(s?"AND p.product_id != ".concat(s):"","    \n                    ").concat(a?"AND c.category_id = ".concat(a):"","\n                    ").concat(o?"AND c.department_id = ".concat(o):"","\n                    ").concat(u?"AND (p.name like '%".concat(u,"%' OR p.description like '%").concat(u,"%')"):"","\n                    ").concat(y||m?"\n                        AND (\n                            discounted_price = 0 AND price between ".concat(y," AND ").concat(m," \n                                OR\n                            discounted_price != 0 AND discounted_price between ").concat(y," AND ").concat(m," )\n                    "):"","\n                    group by p.product_id"),r="WHERE  1 = 1 \n                ".concat(l?"AND (products.sizes like '".concat(l,",%' OR products.sizes like '%,").concat(l,",%' OR products.sizes like '%,").concat(l,"')"):"","\n                ").concat(d?"AND (products.colors like '".concat(d,",%' OR products.colors like '%,").concat(d,",%' OR products.colors like '%,").concat(d,"')"):"","\n                order by products.product_id"),n="SELECT * from (\n                        ".concat(t,"\n                    ) products\n                        ").concat(d||l?r:"","\n                        ").concat(p?"limit ".concat(p.limit):"","\n                        ").concat(p?"offset ".concat(p.offset||0):""),i="SELECT COUNT(1) count from (\n                        ".concat(t,"\n                    ) products\n                        ").concat(d||l?r:"","\n                    "),e.next=6,h.sequelize.query(i,{type:h.Sequelize.QueryTypes.SELECT});case 6:return f=e.sent,e.next=9,h.sequelize.query(n,{type:h.Sequelize.QueryTypes.SELECT});case 9:return g=e.sent,e.abrupt("return",{data:g,count:f[0].count});case 11:case"end":return e.stop()}},e)})));case 5:return e.abrupt("return",e.sent);case 8:e.prev=8,e.t0=e.catch(0),console.log({e:e.t0});case 11:case"end":return e.stop()}},e,null,[[0,8]])}))).apply(this,arguments)}var D,C={};C.maxMinPrice={type:new a.GraphQLObjectType({name:"maxMinPrice",description:"",fields:function(){return{min:{type:a.GraphQLFloat},max:{type:a.GraphQLFloat}}}}),resolve:function(e,t,r,n){return k.apply(this,arguments)}},C.products={type:(D=E,new a.GraphQLObjectType({name:"findCount_".concat(D),fields:function(){return{data:{type:Object(a.GraphQLList)(D)},count:{type:a.GraphQLInt}}}})),args:{categoryId:{type:a.GraphQLInt},departmentId:{type:a.GraphQLInt},paging:{type:N},id:{type:a.GraphQLInt},notId:{type:a.GraphQLInt},autoComplete:{type:a.GraphQLString},color:{type:a.GraphQLString},size:{type:a.GraphQLString},minPrice:{type:a.GraphQLFloat},maxPrice:{type:a.GraphQLFloat}},resolve:function(e,t,r,n){return q.apply(this,arguments)}};var z=new a.GraphQLObjectType({name:"categories",description:"categories",fields:function(){return{id:{type:a.GraphQLInt},name:{type:a.GraphQLString},description:{type:a.GraphQLString}}}}),K=new a.GraphQLObjectType({name:"departments",description:"departments",fields:function(){return{id:{type:a.GraphQLInt},name:{type:a.GraphQLString},description:{type:a.GraphQLString},categories:{type:Object(a.GraphQLList)(z)}}}});function M(e,t,r,n,i,a,o){try{var p=e[a](o),c=p.value}catch(e){return void r(e)}p.done?t(c):Promise.resolve(c).then(n,i)}function F(){var e;return e=regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,h.departments.findAll({include:[{model:h.categories}]});case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),console.log(e.t0);case 9:case"end":return e.stop()}},e,null,[[0,6]])}),(F=function(){var t=this,r=arguments;return new Promise(function(n,i){var a=e.apply(t,r);function o(e){M(a,n,i,o,p,"next",e)}function p(e){M(a,n,i,o,p,"throw",e)}o(void 0)})}).apply(this,arguments)}var U={};U.departments={type:Object(a.GraphQLList)(K),resolve:function(){return F.apply(this,arguments)}};var B=new a.GraphQLObjectType({name:"shipping",description:"shipping",fields:function(){return{id:{type:a.GraphQLInt},shipping_type:{type:a.GraphQLString},shipping_cost:{type:a.GraphQLFloat},shipping_region_id:{type:a.GraphQLInt}}}}),H=new a.GraphQLObjectType({name:"shipping_region",description:"shipping_region",fields:function(){return{id:{type:a.GraphQLInt},shipping_region:{type:a.GraphQLString},shipping:{type:Object(a.GraphQLList)(B)}}}});function W(e,t,r,n,i,a,o){try{var p=e[a](o),c=p.value}catch(e){return void r(e)}p.done?t(c):Promise.resolve(c).then(n,i)}function Y(){var e;return e=regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,h.shipping_region.findAll({include:[{model:h.shipping,as:"shipping"}],order:[["id","ASC"]]});case 3:return e.abrupt("return",e.sent);case 6:e.prev=6,e.t0=e.catch(0),console.log(e.t0);case 9:case"end":return e.stop()}},e,null,[[0,6]])}),(Y=function(){var t=this,r=arguments;return new Promise(function(n,i){var a=e.apply(t,r);function o(e){W(a,n,i,o,p,"next",e)}function p(e){W(a,n,i,o,p,"throw",e)}o(void 0)})}).apply(this,arguments)}var J={};J.shippingRegion={type:Object(a.GraphQLList)(H),resolve:function(){return Y.apply(this,arguments)}};var V=new a.GraphQLObjectType({name:"attributes",description:"attributes",fields:function(){return{name:{type:a.GraphQLString},values:{type:a.GraphQLString},attributeValues:{type:a.GraphQLString}}}});function Z(e,t,r,n,i,a,o){try{var p=e[a](o),c=p.value}catch(e){return void r(e)}p.done?t(c):Promise.resolve(c).then(n,i)}function $(){var e;return e=regeneratorRuntime.mark(function e(t,r,n,i){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,h.attribute.findAll({attributes:[[h.Sequelize.literal("LOWER(GROUP_CONCAT(`attribute_values`.`value` SEPARATOR ','))"),"attributeValues"],"name"],include:[{model:h.attribute_value}],group:["`attribute`.`attribute_id`"],raw:!0});case 3:return a=e.sent,e.abrupt("return",a);case 7:e.prev=7,e.t0=e.catch(0),console.log("Error fetchAttributes",e.t0);case 10:case"end":return e.stop()}},e,null,[[0,7]])}),($=function(){var t=this,r=arguments;return new Promise(function(n,i){var a=e.apply(t,r);function o(e){Z(a,n,i,o,p,"next",e)}function p(e){Z(a,n,i,o,p,"throw",e)}o(void 0)})}).apply(this,arguments)}var X={};X.attributes={type:Object(a.GraphQLList)(V),resolve:function(e,t,r,n){return $.apply(this,arguments)}};var ee=new a.GraphQLObjectType({name:"orders",description:"orders",fields:function(){return{id:{type:a.GraphQLInt},total_amount:{type:a.GraphQLFloat},created_on:{type:a.GraphQLString},shipped_on:{type:a.GraphQLString},status:{type:a.GraphQLInt},comments:{type:a.GraphQLString},customer_id:{type:a.GraphQLInt},auth_code:{type:a.GraphQLString},reference:{type:a.GraphQLString},shipping_id:{type:a.GraphQLInt},tax_id:{type:a.GraphQLInt}}}});function te(e,t,r,n,i,a,o){try{var p=e[a](o),c=p.value}catch(e){return void r(e)}p.done?t(c):Promise.resolve(c).then(n,i)}function re(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){var a=e.apply(t,r);function o(e){te(a,n,i,o,p,"next",e)}function p(e){te(a,n,i,o,p,"throw",e)}o(void 0)})}}function ne(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var ie=r("stripe"),ae=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.stripe=ie("sk_test_lomdOfxbm7QDgZWvR82UhV6D")}var t,r,n;return t=e,(r=[{key:"createPaymentMethod",value:function(){var e=re(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.paymentMethods.create(t);case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e.catch(0),new Error("WRONG_CARD");case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t){return e.apply(this,arguments)}}()},{key:"createPaymentIntent",value:function(){var e=re(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.paymentIntents.create(t);case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e.catch(0),console.log(e.t0),new Error("PAYMENT_FAILED");case 10:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t){return e.apply(this,arguments)}}()},{key:"confirmPayment",value:function(){var e=re(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.paymentIntents.confirm(t);case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e.catch(0),console.log(e.t0),new Error("PAYMENT_FAILED");case 10:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t){return e.apply(this,arguments)}}()},{key:"updatePaymentIntent",value:function(){var e=re(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.paymentIntents.update(t,{metadata:{order_id:"".concat(r)}});case 3:return e.abrupt("return",e.sent);case 6:throw e.prev=6,e.t0=e.catch(0),new Error("ERROR_UPDATING_METADATA",e.t0);case 9:case"end":return e.stop()}},e,this,[[0,6]])}));return function(t,r){return e.apply(this,arguments)}}()}])&&ne(t.prototype,r),n&&ne(t,n),e}(),oe=r("nodemailer"),pe=r.n(oe),ce=r("moment"),se=r.n(ce);function ue(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){de(e,t,r[t])})}return e}function de(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function le(e,t,r,n,i,a,o){try{var p=e[a](o),c=p.value}catch(e){return void r(e)}p.done?t(c):Promise.resolve(c).then(n,i)}function ye(){var e;return e=regeneratorRuntime.mark(function e(t,r,n,i){var a,o,p,c,s,u,d,l,y,m,f,g,_,v,b,G,L,w,S,T,I,R,E,N,Q,x,O,j,A,P,k;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n.user){e.next=2;break}throw new Error("AUTHORIZATION_ERROR");case 2:return a=r.address_1,o=r.address_2,p=void 0===o?"":o,c=r.city,s=r.country,u=r.name,d=r.postal_code,l=r.region,y=r.shipping_region_id,m=r.total_amount,r.comments,f=r.detail,g=r.shipping_id,r.tax_id,r.customer_id,_=r.card,v=_.number,b=_.exp_month,G=_.exp_year,L=_.cvc,w=new ae,e.next=7,w.createPaymentMethod({type:"card",card:{number:v,exp_month:parseInt(b),exp_year:parseInt(G),cvc:L}});case 7:return S=e.sent,T={amount:m.toFixed(2).replace(/\,|\./g,""),currency:"usd",payment_method_types:["card"],payment_method:S.id},e.next=11,w.createPaymentIntent(T);case 11:return I=e.sent,e.next=14,w.confirmPayment(I.id);case 14:if("succeeded"!==(R=e.sent).status){e.next=46;break}return e.next=18,h.orders.create({total_amount:m,created_on:h.Sequelize.fn("NOW"),customer_id:n.user.id,shipping_id:g,reference:R.id},{raw:!0});case 18:return E=e.sent,N=E.get({plain:!0}),e.next=22,h.order_detail.bulkCreate(f.map(function(e){return ue({},e,{order_id:N.id})}),{returning:!0});case 22:return Q=e.sent,e.prev=23,e.next=26,w.updatePaymentIntent(R.id,N.id);case 26:x=e.sent,console.log({updatePayment:x}),e.next=33;break;case 30:e.prev=30,e.t0=e.catch(23),console.log("ERROR AT UPDATE METADATA",e.t0);case 33:return O=pe.a.createTransport({service:"gmail",auth:{user:"yancetest2019@gmail.com",pass:"ferret12345"}}),e.next=36,h.customer.findOne({attributes:["email"],where:{id:n.user.id},raw:!0});case 36:if(j=e.sent,A=j.email,P=f.map(function(e){return"<li>".concat(e.product_name," x ").concat(e.quantity," = $").concat(parseInt(e.quantity)*parseFloat(e.unit_cost),"</li>")}).join(""),k={from:"lyance_test@gmail.com",to:A,subject:"Your order from ".concat(se()().format("DD-MM-YYYY @Â HH:mm")),html:"<p>Order confirmed!!!</p>\n                <ul>\n                ".concat(P,"\n                </ul>\n            <p>Total: $ ").concat(m,"</p>")},h.customer.update({address_1:a,address_2:p,city:c,country:s,name:u,postal_code:d,region:l,shipping_region_id:y},{where:{id:n.user.id}}),O.sendMail(k,function(e,t){e?console.log(e):console.log(t)}),!Q){e.next=44;break}return e.abrupt("return",{id:N.id});case 44:e.next=47;break;case 46:throw new Error("PAYMENT_FAILED");case 47:case"end":return e.stop()}},e,null,[[23,30]])}),(ye=function(){var t=this,r=arguments;return new Promise(function(n,i){var a=e.apply(t,r);function o(e){le(a,n,i,o,p,"next",e)}function p(e){le(a,n,i,o,p,"throw",e)}o(void 0)})}).apply(this,arguments)}var he,me=r("graphql-type-json"),fe=r.n(me),ge=new a.GraphQLObjectType({name:"order_detail",description:"order_detail",fields:function(){return{product_id:{type:a.GraphQLInt},attributes:{type:a.GraphQLString},product_name:{type:a.GraphQLString},quantity:{type:a.GraphQLInt},unit_cost:{type:a.GraphQLFloat}}}});function _e(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var ve={};function be(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){Ge(e,t,r[t])})}return e}function Ge(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}ve.order={type:ee,args:(he={address_1:{type:a.GraphQLString},address_2:{type:a.GraphQLString},city:{type:a.GraphQLString},country:{type:a.GraphQLString},name:{type:a.GraphQLString},postal_code:{type:a.GraphQLString},region:{type:a.GraphQLString},shipping_region_id:{type:a.GraphQLInt},total_amount:{type:a.GraphQLFloat},comments:{type:a.GraphQLString},detail:{type:fe.a},shipping_id:{type:a.GraphQLInt},tax_id:{type:a.GraphQLInt},customer_id:{type:a.GraphQLInt}},_e(he,"detail",{type:Object(a.GraphQLList)(new a.GraphQLInputObjectType({name:"input_detail_order",fields:ge.getFields()}))}),_e(he,"card",{type:new a.GraphQLInputObjectType({name:"input_card_order",fields:new a.GraphQLObjectType({name:"cardType",description:"",fields:function(){return{number:{type:a.GraphQLString},exp_month:{type:a.GraphQLString},exp_year:{type:a.GraphQLString},cvc:{type:a.GraphQLString}}}}).getFields()})}),he),resolve:function(e,t,r,n){return ye.apply(this,arguments)}};var Le=new a.GraphQLObjectType({name:"query",description:"...",fields:function(){return be({},I,C,U,J,X)}}),we=new a.GraphQLObjectType({name:"mutations",description:"...",fields:function(){return be({},R,ve)}}),Se=new a.GraphQLSchema({query:Le,mutation:we}),Te=r("express"),Ie=r("express-graphql"),Re=i,Ee=Re.ide,Ne=Re.pretty,Qe=n,xe=Te.Router();console.info("GRAPHQL STARTING..."),xe.use(Qe,function(e,t){Ie({schema:Se,graphiql:Ee,pretty:Ne,formatError:function(e){return e.message}})(e,t)});t.a=xe},0:function(e,t,r){r("@babel/polyfill"),e.exports=r("./index.js")},"@babel/polyfill":function(e,t){e.exports=require("@babel/polyfill")},async:function(e,t){e.exports=require("async")},"body-parser":function(e,t){e.exports=require("body-parser")},cors:function(e,t){e.exports=require("cors")},cryptr:function(e,t){e.exports=require("cryptr")},dotenv:function(e,t){e.exports=require("dotenv")},express:function(e,t){e.exports=require("express")},"express-graphql":function(e,t){e.exports=require("express-graphql")},"express-rate-limit":function(e,t){e.exports=require("express-rate-limit")},"express-unless":function(e,t){e.exports=require("express-unless")},graphql:function(e,t){e.exports=require("graphql")},"graphql-type-json":function(e,t){e.exports=require("graphql-type-json")},http:function(e,t){e.exports=require("http")},moment:function(e,t){e.exports=require("moment")},morgan:function(e,t){e.exports=require("morgan")},"node-cache":function(e,t){e.exports=require("node-cache")},nodemailer:function(e,t){e.exports=require("nodemailer")},path:function(e,t){e.exports=require("path")},sequelize:function(e,t){e.exports=require("sequelize")},sha1:function(e,t){e.exports=require("sha1")},stripe:function(e,t){e.exports=require("stripe")}});